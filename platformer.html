<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<style>
		html, body {
			height: 100%;
			padding: 0px;
			margin: 0px;
			background: wheat;
			/*overflow: hidden;*/
		}
		.cube{
		  background: yellowgreen;
		  width: 40px;
		  height: 40px;
		  position: absolute;
		  top: 140px;
		}
		.floor{
		  background: gray;
		  width: 100%;
		  height: 20px;
		  position: absolute;
		  top: 400px;
		}
		.block{
			background: gray;
		  width: 40px;
		  height: 40px;
		  position: absolute;
		  top: 360px;
		  left: 160px;
		}
	</style>
</head>
<body>
	<div id="container" style='width:100%; height:100%;'>
	  <div class="cube"></div>
	  <div class="floor" data-solid="true"></div>
	  <div class="block" data-solid="true"></div>
	</div>
	<script>
	const speed = 10;
	const gravity = 0.98;

	const tempFloorPos = 400;

	const controls = {
		left: "ArrowLeft",
		right: "ArrowRight",
		jump: " ",
	}

	const pressedKeys = {
		left: false,
		right: false,
		jump: 0
	}

	const cube = {
		x: 0,
		y: 0,
		height: 40,
		width: 40,
		gravity: 0,
		speed: 0,

	}

	window.addEventListener("keydown", function(e){
	  // console.log("ki", e.key)
	  keyDown(e.key)
	})
	window.addEventListener("keyup", function(e){
	  // console.log("ki", e.key)
	  keyUp(e.key)
	})

	function keyDown(key){
	  switch (key){
	    case controls.left:
				pressedKeys.left = true;
				move(-1);
	      break;
	    case controls.right:
				pressedKeys.right = true;
				move(1);
	    break;

			case controls.jump:
			window.requestAnimationFrame(function(){
				if (pressedKeys.jump < 2){
					pressedKeys.jump++;
					jump();
				}
			})
	    break;
	  }
	}

	function keyUp(key){
		switch (key){
	    case controls.left:
		     pressedKeys.left = false;
	      break;
	    case controls.right:
				pressedKeys.right = false;
	    break;
		}
	}

	function move(direction){
		cube.speed = speed * direction
	}
	function jump(){
		cube.gravity = -15

	  //console.log(direction, speed, x, cube.style.left)
	  // getCube().style.top = x + speed * direction + "px";
	}

	function getCube(){
	  const cube = document.querySelector(".cube");
	  return cube;
	}

	function getEl(x, y){
		const el = document.elementFromPoint(x, y);
		if (el && el.dataset.solid){
			return el.getBoundingClientRect();
		}
	}

	function render(){
		window.requestAnimationFrame(render);

		// gravity
		const bottom = cube.y + cube.height;
		const elementBelow = getEl(cube.x, bottom) || getEl(cube.x + cube.width, bottom);
		if (elementBelow){
			if (bottom + cube.gravity <= elementBelow.y){
				cube.gravity += gravity;
				cube.y = cube.y + cube.gravity;
			}
			else {
				cube.y += elementBelow.y - bottom;
				pressedKeys.jump = 0;
			}
		} else {
			cube.gravity += gravity;
			cube.y = cube.y + cube.gravity;
		}
		getCube().style.top = cube.y + "px"

		// speed
		if (pressedKeys.left || pressedKeys.right){
			if (pressedKeys.left){
				const elementLeft = getEl(cube.x - 1, cube.y);
				if (elementLeft) {
					cube.speed = 0
				}
			}
			if (pressedKeys.right){
				const elementRight = getEl(cube.x + cube.width + 1, cube.y);
				if (elementRight) {
					cube.speed = 0
				}
			}
		}
		else {
			cube.speed = 0
		}
		cube.x += cube.speed;
	  getCube().style.left = cube.x + "px";


	}
	// setInterval(render, 50)
	render()

	</script>
</body>
