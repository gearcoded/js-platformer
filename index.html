<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<style>
		html, body {
			height: 100%;
			padding: 0px;
			margin: 0px;
			background: wheat;
			/*overflow: hidden;*/
		}
		.cube{
		  background: yellowgreen;
		  width: 40px;
		  height: 40px;
		  position: absolute;
		  top: 140px;
		}
		.floor{
		  background: gray;
		  width: 100%;
		  height: 20px;
		  position: absolute;
		  top: 400px;
		}
		.block{
			background: gray;
		  width: 40px;
		  height: 40px;
		  position: absolute;
		}
	</style>
</head>
<body>
	<div id="container" style='width:100%; height:100%;'>
	  <div class="floor" data-solid="true"></div>
	</div>
	<script>
	const speed = 10;
	const gravity = 0.98;

	const tempFloorPos = 400;

	const controls = {
		left: "ArrowLeft",
		right: "ArrowRight",
		jump: " ",
	}

	const pressedKeys = {
		left: false,
		right: false,
		jump: 0
	}



	const objects = JSON.parse(
		'{"player":{"className":"cube","x":350,"y":360,"height":40,"width":40,"solid":false,"gravity":20.280000000000012,"speed":0},"blocks":{"className":"block","solid":true,"positions":[{"x":360,"y":180},{"x":650,"y":320},{"x":620,"y":360},{"x":160,"y":360}]}}'
	);

	const cube = objects.player;

	window.addEventListener("mousedown", function(e){
		if (e.shiftKey){
			moveElement(e.target)
		}
		console.log(e)
		if (e.ctrlKey){
			cloneElement(e.target)
		}
	})

	let movedElement = null;
	function moveElement(el){
		movedElement = el;
	}

	function cloneElement(el){
		let clone = el.cloneNode();
		clone.style.left = parseInt(clone.style.left) + 10 + "px";
		clone.style.top = parseInt(clone.style.top) + 10 + "px";
		const root = document.querySelector("#container");
		root.appendChild(clone)
	}

	window.addEventListener("mousemove", function(e){
		if (movedElement){
			const rect = movedElement.getBoundingClientRect()
			movedElement.style.left = e.clientX - rect.width / 2 + "px";
			movedElement.style.top = e.clientY - rect.height / 2 + "px";
		}
	})

	window.addEventListener("mouseup", function(e){
		movedElement = null;
	})


	window.addEventListener("keydown", function(e){
	  // console.log("ki", e.key)
	  keyDown(e.key)
	})
	window.addEventListener("keyup", function(e){
	  // console.log("ki", e.key)
	  keyUp(e.key)
	})

	function keyDown(key){
	  switch (key){
	    case controls.left:
				pressedKeys.left = true;
				move(-1);
	      break;
	    case controls.right:
				pressedKeys.right = true;
				move(1);
	    break;

			case controls.jump:
			window.requestAnimationFrame(function(){
				if (pressedKeys.jump < 2){
					pressedKeys.jump++;
					jump();
				}
			})
	    break;
	  }
	}

	function keyUp(key){
		switch (key){
	    case controls.left:
		     pressedKeys.left = false;
	      break;
	    case controls.right:
				pressedKeys.right = false;
	    break;
		}
	}

	function move(direction){
		cube.speed = speed * direction
	}
	function jump(){
		cube.gravity = -15

	  //console.log(direction, speed, x, cube.style.left)
	  // getCube().style.top = x + speed * direction + "px";
	}

	function getCube(){
	  const cube = document.querySelector(".cube");
	  return cube;
	}

	function getEl(x, y){
		const el = document.elementFromPoint(x, y);
		if (el && el.dataset.solid){
			return el.getBoundingClientRect();
		}
	}

	function render(){
		window.requestAnimationFrame(render);

		// gravity
		const bottom = cube.y + cube.height;
		const elementBelow = getEl(cube.x, bottom) || getEl(cube.x + cube.width, bottom);
		if (elementBelow){
			if (bottom + cube.gravity <= elementBelow.y){
				cube.gravity += gravity;
				cube.y = cube.y + cube.gravity;
			}
			else {
				cube.y += elementBelow.y - bottom;
				pressedKeys.jump = 0;
			}
		} else {
			cube.gravity += gravity;
			cube.y = cube.y + cube.gravity;
		}
		getCube().style.top = cube.y + "px"

		// speed
		if (pressedKeys.left || pressedKeys.right){
			if (pressedKeys.left){
				const elementLeft = getEl(cube.x - 1, cube.y);
				if (elementLeft) {
					cube.speed = 0
				}
			}
			if (pressedKeys.right){
				const elementRight = getEl(cube.x + cube.width + 1, cube.y);
				if (elementRight) {
					cube.speed = 0
				}
			}
		}
		else {
			cube.speed = 0
		}
		cube.x += cube.speed;
	  getCube().style.left = cube.x + "px";


	}
	// setInterval(render, 50)
	generateObjects()

	render()



	function generateObjects(){
		for (name in objects){
			const entity = objects[name];

			if (entity.positions){
				entity.positions.forEach(function(position){
					addElement(entity.className, position, entity.solid)
				})
			}
			else {
				const position = {x:entity.x, y: entity.y, width: entity.width, height: entity.height};
				addElement(entity.className, position, entity.solid)
			}
		}
	}

	function addElement(className, position, solid){
		const el = document.createElement("div")
		el.className = className;
		el.style.left = position.x + "px";
		el.style.top = position.y + "px";
		el.style.height = position.height + "px";
		el.style.width = position.width + "px";
		if (solid){
			el.setAttribute("data-solid", true)
		}
		const root = document.querySelector("#container");
		root.appendChild(el)
	}

	function savePositions(){
		for (name in objects){
			const entity = objects[name];
			if (entity.positions){
				const els = document.querySelectorAll("." + entity.className);
				entity.positions = [];
				els.forEach(function(el){
					entity.positions.push({x: parseInt(el.style.left) || 0, y: parseInt(el.style.top) || 0})
				})
			}
			else {
				const el = document.querySelector("." + entity.className);
				entity.x = parseInt(el.style.left) || 0;
				entity.y = parseInt(el.style.top) || 0;
			}
		}
		return JSON.stringify(objects)
	}

	</script>
</body>
